<!DOCTYPE HTML>
<!--
	Future Imperfect by HTML5 UP
	html5up.net | @ajlkn
	Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html>
<head>
	<title>Kitty Litter - </title>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
	<link rel="stylesheet" href="/css/main.css" />
</head>
<body class="is-preload">

	<!-- Wrapper -->
	<div id="wrapper">

		<!-- Header -->
		<header id="header">
			<h1><a href="/index.html"> <img src="/images/logo.png"> Kitty Litter</a></h1>
			<nav class="links">
				<ul>
  <li><a href="/blog/index.html">Blog</a></li>
</ul>

			</nav>
			<nav class="main">
				<ul>
					<!-- <li class="search">
						<a class="fa-search" href="#search">Search</a>
						<form id="search" method="get" action="#">
							<input type="text" name="query" placeholder="Search" />
						</form>
					</li> -->
					<li class="menu">
						<a class="fa-bars" href="#menu">Menu</a>
					</li>
				</ul>
			</nav>
		</header>

		<!-- Menu -->
		<section id="menu">
			<!-- Search -->
			<!-- <section>
				<form class="search" method="get" action="#">
					<input type="text" name="query" placeholder="Search" />
				</form>
			</section> -->

			<!-- Links -->
			<section>
				<ul class="links">
			
					<li>
						<a href="/blog/index.html">
							<h3>Blog</h3>
							<p></p>
						</a>
					</li>
			
				</ul>
			</section>

			<!-- Actions -->
			<!-- <section>
				<ul class="actions stacked">
					<li><a href="#" class="button large fit">Log In</a></li>
				</ul>
			</section> -->
		</section>

		<!-- Main -->
		<div id="main">
			
<!-- Post -->

  <article class="post">
    <header>
      <div class="title">
        <h2><a href="/blog/alternative-enum-choices.html">An alternative to Enum for Choices</a></h2>
      </div>
      <div class="meta">
        <time class="published" datetime="2017-05-15">Mon, 15 May 2017</time>
      </div>
    </header>
    <a href="single.html" class="image featured"><img src="images/pic01.jpg" alt="" /></a>
    <p><p>Those who've been reading my older posts may remember I showed how you could use Enum and IntEnum as a cleaner way to declare const-type values for choices lists in Django fields.</p>

<p>That solution never felt comfortable to me, because Enum values aren't simple values.</p>

<p>So after some playing around, and a brief look over the enum.py in python 3.5, I've come up with the following:</p>

<pre><code>class ChoiceProperty:
    '''Descriptor class for yielding values, but not allowing setting.'''
    def __init__(self, value):
        self.value = value

    def __get__(self, instance, cls=None):
        return self.value


class MetaChoices(type):
    @classmethod
    def __prepare__(mcs, name, bases, **kwargs):
        '''Use an ordered dict for declared values.'''
        return OrderedDict()

    def __new__(mcs, name, bases, attrs):
        _choices = OrderedDict()
        _label_map = {}

        for name, value in list(attrs.items()):
            if not name.isupper():
  </code></pre></p>
    <footer>
      <ul class="actions">
        <li><a href="/blog/alternative-enum-choices.html" class="button large">Continue Reading</a></li>
      </ul>
    </footer>
  </article>
  
  <article class="post">
    <header>
      <div class="title">
        <h2><a href="/blog/django-registration-redux.html">Django Registration redux</a></h2>
      </div>
      <div class="meta">
        <time class="published" datetime="2018-08-14">Tue, 14 Aug 2018</time>
      </div>
    </header>
    <a href="single.html" class="image featured"><img src="images/pic01.jpg" alt="" /></a>
    <p><p>So, 4 years ago [already??] I wrote a post about a shortcut to getting "User
registration with verification email", using very little code by leveraging the
password reset machinery built into Django.</p>

<p>Since then, of course, Django has moved on... and recently, the auth views were
rewritten as class-based views, which changes the game entirely.</p>

<p>As a result, I've committed to providing here an updated version of the
previous post.</p>

<p>A lot of the following is copied verbatim from the previous article, but I will
update the docs links (from Django 1.7 to 2.1) and clarify where it's been
found valuable.</p>

<p>It's important to note that you should do all of this right at the very <em>start</em> of your project, as advised <a href="https://docs.djangoproject.com/en/2.1/topics/auth/customizing/#using-a-custom-user-model-when-starting-a-project">here</a></p>

<h2>Step 1: User model</h2>

<p>This step has not changed much. We follow the steps
</p>
    <footer>
      <ul class="actions">
        <li><a href="/blog/django-registration-redux.html" class="button large">Continue Reading</a></li>
      </ul>
    </footer>
  </article>
  
  <article class="post">
    <header>
      <div class="title">
        <h2><a href="/blog/environment-driven-config.html">Environment driven config</a></h2>
      </div>
      <div class="meta">
        <time class="published" datetime="2019-01-20">Sun, 20 Jan 2019</time>
      </div>
    </header>
    <a href="single.html" class="image featured"><img src="images/pic01.jpg" alt="" /></a>
    <p><p>Some years ago, I adapted the work of a coworker and released it as <code>django-classy-settings</code>, a way to define Django settings using a class, allowing a clean and easy way to derive local / production settings from a common base, and opening the way to allowing composition, too.</p>

<p>Recently I was faced with a similar problem at my current job, though not using Django this time.</p>

<p>Another big difference is my current job is using Python3.6 (and eager to move to 3.7 ASAP), opening other opportunities.</p>

<h2>Setting the scene</h2>

<p>They already had a config module that pulled values from the environment [for most of them], and pushed them through helper functions for casting types [like bools, ints, etc]</p>

<p>This would look something like:</p>

<pre><code>USE_MAGIC = parse_bool(os.getenv('USE_MAGIC', False))

DATABASE_NAME = os.getenv('DATABASE_NAME', 'production-database-1')
DATABASE_PORT = int(os.getenv('DATABASE_PORT', 5432))
</code></pre>

<p>However,</p>
    <footer>
      <ul class="actions">
        <li><a href="/blog/environment-driven-config.html" class="button large">Continue Reading</a></li>
      </ul>
    </footer>
  </article>
  
  <article class="post">
    <header>
      <div class="title">
        <h2><a href="/blog/intenum-choices-django.html">IntEnum for Choices in Django</a></h2>
      </div>
      <div class="meta">
        <time class="published" datetime="2015-10-28">Wed, 28 Oct 2015</time>
      </div>
    </header>
    <a href="single.html" class="image featured"><img src="images/pic01.jpg" alt="" /></a>
    <p><p>So, we've all needed a <code>choices</code> list in Django at one time or another, right?</p>

<p>And from the docs we see the example code:</p>

<pre><code>YEAR_IN_SCHOOL_CHOICES = (
    ('FR', 'Freshman'),
    ('SO', 'Sophomore'),
    ('JR', 'Junior'),
    ('SR', 'Senior'),
)
</code></pre>

<p>Which is then quickly amended to:</p>

<pre><code>class Student(models.Model):
    FRESHMAN = 'FR'
    SOPHOMORE = 'SO'
    JUNIOR = 'JR'
    SENIOR = 'SR'
    YEAR_IN_SCHOOL_CHOICES = (
        (FRESHMAN, 'Freshman'),
        (SOPHOMORE, 'Sophomore'),
        (JUNIOR, 'Junior'),
        (SENIOR, 'Senior'),
    )
    year_in_school = models.CharField(max_length=2,
                                      choices=YEAR_IN_SCHOOL_CHOICES,
                                      default=FRESHMAN)
</code></pre>

<p>Why?  Because this avoids the problem of <code>magic values</code>, an aspect of keeping DRY.</p>

<p>Magic values are constants that have meaning; they become a problem [especially with nu</p>
    <footer>
      <ul class="actions">
        <li><a href="/blog/intenum-choices-django.html" class="button large">Continue Reading</a></li>
      </ul>
    </footer>
  </article>
  
  <article class="post">
    <header>
      <div class="title">
        <h2><a href="/blog/modern-vanilla-js-cookie-parsing.html">Modern Vanilla JS for cookie parsing</a></h2>
      </div>
      <div class="meta">
        <time class="published" datetime="2018-10-05">Fri, 05 Oct 2018</time>
      </div>
    </header>
    <a href="single.html" class="image featured"><img src="images/pic01.jpg" alt="" /></a>
    <p><p>In a <a href="/blog/2015/aug/28/vanilla-js-meets-djangos-csrf/">previous post</a> I wrote a Vanilla JS function for parsing all the current cookies. Since then a couple of things have happened:</p>

<ol>
<li>I realised it was not safe</li>
<li>JS in browsers got better [and I got better at it]</li>
</ol>

<p>It was not safe in as much as it parsed the cookie value once and retained the value. If you were, for instance,  using a SPA, Django might update the CSRF token at any point, making your value stale.  So instead, I've updated the function to get just one value, and perform parsing on each call.</p>

<pre><code>function getCookie (name) {
  let value;

  (document.cookie || '')
    .split(';')
    .map(c =&gt; c.trim().match(/(\w+)=(.*)/))
    .forEach(([m, k, v]) =&gt; {
      if (m !== undefined &amp;&amp; decodeURIComponent(k) === name) {
        value = decodeURIComponent(v);
      }
    });
  return value;
}
</code></pre>

<p>So the process is much the same. We declare a va</p>
    <footer>
      <ul class="actions">
        <li><a href="/blog/modern-vanilla-js-cookie-parsing.html" class="button large">Continue Reading</a></li>
      </ul>
    </footer>
  </article>
  
  <article class="post">
    <header>
      <div class="title">
        <h2><a href="/blog/no-your-web-framework-not-mvc.html">No, your web framework is not MVC</a></h2>
      </div>
      <div class="meta">
        <time class="published" datetime="2015-12-18">Fri, 18 Dec 2015</time>
      </div>
    </header>
    <a href="single.html" class="image featured"><img src="images/pic01.jpg" alt="" /></a>
    <p><p>Whilst it is theoretically possible, I've yet to see a single server-side web framework that is MVC.</p>

<p>"Oh, pshaw!", I hear you say, "But {framework of choice} says it is!  So it must be!"</p>

<p>Yeah, and MySQL says it's a good DBMS...</p>

<h2>What is MVC?</h2>

<p>MVC - Model / View / Controller - is a design pattern for GUI applications to affect "separation of concerns".  This allows each part of the application to be loosely coupled, improving isolation, and enforcing adherence to interfaces.</p>

<p>The Model provides interfaces to the state of the application and whatever data it accesses.</p>

<p>The View subscribes to changes in the Model, and presents the information in a meaningful way to the "user".</p>

<p>When the user interacts with the View, it sends actions to the Controller, which performs the work, and (in most cases) updates the application state by changing the Model.</p>

<p>And around it goes.  Model changes state, View updates, etc.  Changes and updat</p>
    <footer>
      <ul class="actions">
        <li><a href="/blog/no-your-web-framework-not-mvc.html" class="button large">Continue Reading</a></li>
      </ul>
    </footer>
  </article>
  
  <article class="post">
    <header>
      <div class="title">
        <h2><a href="/blog/parsing-search-strings.html">Parsing search strings</a></h2>
      </div>
      <div class="meta">
        <time class="published" datetime="2015-05-03">Sun, 03 May 2015</time>
      </div>
    </header>
    <a href="single.html" class="image featured"><img src="images/pic01.jpg" alt="" /></a>
    <p><p>We've all had to write a search form at some point.  Beyond simple cases, you reach for the big guns, like haystack, et al.</p>

<p>But what about when it's just something simple?  What if you want to, for instance, let people search your blog posts?</p>

<p>In django, that can be done simply with:</p>

<pre><code>Blog.objects.filter(Q(title__icontains=word) | Q(body__icontains=word))
</code></pre>

<p>Which is fine, until someone wants to look for a post on, for instance "django" and "cookies", as opposed to the phrase "django cookies".</p>

<p>So, we need to split up the search terms, and iteratively filter for them:</p>

<pre><code>qset = Blog.posts.all()
for term in terms.split(' '):
    qset = qset.filter(Q(title__icontains=term) | Q(body__icontains=term))
</code></pre>

<p>Which is all great, until you want to search for "apt-get install" and "postgres" as separate terms.  Reflexively you're probably thinking you'd do just that - put quotes around the terms to force groupings.</p>
    <footer>
      <ul class="actions">
        <li><a href="/blog/parsing-search-strings.html" class="button large">Continue Reading</a></li>
      </ul>
    </footer>
  </article>
  
  <article class="post">
    <header>
      <div class="title">
        <h2><a href="/blog/serialiser-hurry.html">Serialiser in a hurry</a></h2>
      </div>
      <div class="meta">
        <time class="published" datetime="2015-08-14">Fri, 14 Aug 2015</time>
      </div>
    </header>
    <a href="single.html" class="image featured"><img src="images/pic01.jpg" alt="" /></a>
    <p><p>Serialisers are increasingly important now that most web apps are just APIs for the JavaScript to consume.</p>

<p>Serialisers help to reduce your living code objects into simpler types that can be encoded in your serialisation format [typically JSON].  After all, JSON has no date or time types, no classes, etc.</p>

<p>In the Django world, modern REST API libraries separate their Serialiser from the views, and go to great lengths to make them easy to configure, simple to use, and fast.  They also support returning your "deflated" data into live code objects.</p>

<p>However, sometimes you don't need all that.  You know what you need, and it's simple.</p>

<h2>The goal</h2>

<p>A simple and fast way to turn our object's attributes into a dict of values.</p>

<h2>The tools</h2>

<p>So I've cobbled together a cheeky solution using two great tools from Python's standard library:  operator.attrgetter and collections.namedtuple</p>

<h2>The steps</h2>

<p>First, attrgetter is a factory t</p>
    <footer>
      <ul class="actions">
        <li><a href="/blog/serialiser-hurry.html" class="button large">Continue Reading</a></li>
      </ul>
    </footer>
  </article>
  
  <article class="post">
    <header>
      <div class="title">
        <h2><a href="/blog/simplest-api.html">The simplest API</a></h2>
      </div>
      <div class="meta">
        <time class="published" datetime="2016-07-17">Sun, 17 Jul 2016</time>
      </div>
    </header>
    <a href="single.html" class="image featured"><img src="images/pic01.jpg" alt="" /></a>
    <p><p>So, I saw a post recently about <a href="https://impythonist.wordpress.com/2015/07/12/build-an-api-under-30-lines-of-code-with-python-and-flask/">Build an API under 30 lines of code</a> using Flask.</p>

<p>I started wondering what it would take to do the same in Django.</p>

<p>The two main tools we're going go use are <code>JsonResponse</code> and <code>ModelForm</code>.</p>

<p><code>JsonResponse</code> is a sub-class of <code>HttpResponse</code> that JSON encodes the data you pass it.</p>

<p>And the <code>ModelForm</code> has a way to pull field values from a model instance.</p>

<p>So... let's create a project:</p>

<pre><code>$ virtualenv -p python3 env
$ . env/bin/activate
$ pip install Django
$ django-admin startproject salary
$ cd salary
</code></pre>

<p>Add our project as an app, by adding "salary", to <code>INSTALLED_APPS</code>.</p>

<h1>Models</h1>

<p>Into <code>salary/models.py</code> put:</p>

<pre><code>from django.db import models


class Salary(models.Model):
  </code></pre></p>
    <footer>
      <ul class="actions">
        <li><a href="/blog/simplest-api.html" class="button large">Continue Reading</a></li>
      </ul>
    </footer>
  </article>
  
  <article class="post">
    <header>
      <div class="title">
        <h2><a href="/blog/updating-two-models-single-post.html">Updating two models in a single post</a></h2>
      </div>
      <div class="meta">
        <time class="published" datetime="2015-06-10">Wed, 10 Jun 2015</time>
      </div>
    </header>
    <a href="single.html" class="image featured"><img src="images/pic01.jpg" alt="" /></a>
    <p><p>This comes up a lot in #django ... and the solution is [as many are with Django] much simpler than people assume.</p>

<p>Frequently I see people reach for formsets, in the mistaken conclusion that formsets are for operating on related models.  The sad part is that formsets rely on the same functionality that the proper solution relies on, but the seeker does not see it.</p>

<p>Somewhere people get the idea that for a single &lt;form&gt; submission, they can only use a single Form class... but the formset should show that that's not true; it uses multiple forms from the one submission.</p>

<h2>The answer</h2>

<p>So, as a simple example, here's a view that updates a User and their Profile in one view:</p>

<pre><code>def user_edit(request):

    if request.method == 'POST':
        user_form = UserForm(request.POST, instance=request.user)
        profile_form = ProfileForm(request.POST, instancel=request.user.profile)

        if all([user_form.is_valid(), profile_form.is_valid()]</code></pre></p>
    <footer>
      <ul class="actions">
        <li><a href="/blog/updating-two-models-single-post.html" class="button large">Continue Reading</a></li>
      </ul>
    </footer>
  </article>
  
  <article class="post">
    <header>
      <div class="title">
        <h2><a href="/blog/vanilla-js-meets-djangos-csrf.html">Vanilla JS meets Django's CSRF</a></h2>
      </div>
      <div class="meta">
        <time class="published" datetime="2015-08-28">Fri, 28 Aug 2015</time>
      </div>
    </header>
    <a href="single.html" class="image featured"><img src="images/pic01.jpg" alt="" /></a>
    <p><p>I was recently helping someone who was trying to learn about building web sites, and was trying to avoid learning too many things at once, so opted to avoid JS libraries for now.</p>

<p>As the discussion progressed, they ran into Django's <a href="https://docs.djangoproject.com/en/1.8/ref/csrf/">Cross Site Request Forgery protection</a> which stumped them.</p>

<p>So, as I was about to link them to the part of the docs that shows how to add the CSRF token from the cookie to your headers, I realised it all assumes you're using jQuery.</p>

<p>Now, that wasn't a bad assumption at the time, but it wasn't viable for this discussion.  So I decided to put my hand to writing a vanilla JS solution.</p>

<p>First step: get the CSRF token cookie.</p>

<pre><code>//
// Find the CSRF Token cookie value
//

function parse_cookies() {
    var cookies = {};
    if (document.cookie &amp;&amp; document.cookie !== '') {
        document.cookie.split(';').forEach(function (c) {
            var m = c.</code></pre></p>
    <footer>
      <ul class="actions">
        <li><a href="/blog/vanilla-js-meets-djangos-csrf.html" class="button large">Continue Reading</a></li>
      </ul>
    </footer>
  </article>
  
  <article class="post">
    <header>
      <div class="title">
        <h2><a href="/blog/wrapping-views-decorators.html">Wrapping views with decorators</a></h2>
      </div>
      <div class="meta">
        <time class="published" datetime="2014-10-29">Wed, 29 Oct 2014</time>
      </div>
    </header>
    <a href="single.html" class="image featured"><img src="images/pic01.jpg" alt="" /></a>
    <p><p>Django provides many decorators for use throughout your project.  They can be great time savers, and mastering them can help you DRY your code considerable.  However, they often confuse people as to how they work, or how to write their own.</p>

<p>In this post I plan to walk through an example of building up a simple decorator that tests if the user has a specific permission, and if not returning a 403 Forbidden response.</p>

<h1>Decorator basics.</h1>

<p>The decorator syntax does <em>not</em> add anything you can't already do in other ways.</p>

<pre><code>def myview(...):
    ...

myview = mydecorator(myview)
</code></pre>

<p>is equivalent to:</p>

<pre><code>@mydecorator
def myview(...):
    ...
</code></pre>

<p>That's right - a decorator just calls your decorator function, passing your function [or class] as its only argument, and assigning the result to the same name.</p>

<h1>Common Code</h1>

<p>So, in this scenario you would find yourself starting a lot of views like th</p>
    <footer>
      <ul class="actions">
        <li><a href="/blog/wrapping-views-decorators.html" class="button large">Continue Reading</a></li>
      </ul>
    </footer>
  </article>
  


		</div>

		<!-- Sidebar -->
		<section id="sidebar">
			<!-- Intro -->
			<section id="intro">
				<a href="/" class="logo"><img src="images/logo.jpg" alt="" /></a>
				<header>
					<h2>Tags</h2>
					<!-- <p>Tags</p> -->
				</header>
			</section>
			
<!-- Links -->
<section>
  <header>
    <h2>Tags</h2>
  </header>
  <ul class="posts">

    <li>
      <article>
        <header>
          <a href="/blog/tags/django.html">
            <h3>django</h3>
            <p>12 posts.</p>
          </a>
        </header>
      </article>
    </li>

    <li>
      <article>
        <header>
          <a href="/blog/tags/python.html">
            <h3>python</h3>
            <p>9 posts.</p>
          </a>
        </header>
      </article>
    </li>

    <li>
      <article>
        <header>
          <a href="/blog/tags/code.html">
            <h3>code</h3>
            <p>4 posts.</p>
          </a>
        </header>
      </article>
    </li>

    <li>
      <article>
        <header>
          <a href="/blog/tags/javascript.html">
            <h3>javascript</h3>
            <p>4 posts.</p>
          </a>
        </header>
      </article>
    </li>

    <li>
      <article>
        <header>
          <a href="/blog/tags/forms.html">
            <h3>forms</h3>
            <p>3 posts.</p>
          </a>
        </header>
      </article>
    </li>

    <li>
      <article>
        <header>
          <a href="/blog/tags/csrf.html">
            <h3>csrf</h3>
            <p>3 posts.</p>
          </a>
        </header>
      </article>
    </li>

    <li>
      <article>
        <header>
          <a href="/blog/tags/enum.html">
            <h3>enum</h3>
            <p>2 posts.</p>
          </a>
        </header>
      </article>
    </li>

    <li>
      <article>
        <header>
          <a href="/blog/tags/decorators.html">
            <h3>decorators</h3>
            <p>2 posts.</p>
          </a>
        </header>
      </article>
    </li>

    <li>
      <article>
        <header>
          <a href="/blog/tags/compression.html">
            <h3>compression</h3>
            <p>1 posts.</p>
          </a>
        </header>
      </article>
    </li>

    <li>
      <article>
        <header>
          <a href="/blog/tags/registration.html">
            <h3>registration</h3>
            <p>1 posts.</p>
          </a>
        </header>
      </article>
    </li>

    <li>
      <article>
        <header>
          <a href="/blog/tags/pony.html">
            <h3>pony</h3>
            <p>1 posts.</p>
          </a>
        </header>
      </article>
    </li>

    <li>
      <article>
        <header>
          <a href="/blog/tags/mvc.html">
            <h3>mvc</h3>
            <p>1 posts.</p>
          </a>
        </header>
      </article>
    </li>

    <li>
      <article>
        <header>
          <a href="/blog/tags/postgres.html">
            <h3>postgres</h3>
            <p>1 posts.</p>
          </a>
        </header>
      </article>
    </li>

  </ul>
</section>


			<!-- Posts List -->
			<!-- <section>
				<ul class="posts">
					<li>
						<article>
							<header>
								<h3><a href="single.html">Congue ullam corper lorem ipsum dolor</a></h3>
								<time class="published" datetime="2015-10-06">October 7, 2015</time>
							</header>
							<a href="single.html" class="image"><img src="images/pic12.jpg" alt="" /></a>
						</article>
					</li>
				</ul>
			</section> -->

			<!-- About -->
			<section class="blurb">
				<h2>About</h2>
				<p>Hi!</p>
				<p>I'm <strong>FunkyBob</strong>, also know as <small>Curtis Maloney</small>.</p>
				<p>Contained herein are some things I thought important enough to write about.</p>
				<!-- <ul class="actions">
					<li><a href="#" class="button">Learn More</a></li>
				</ul> -->
			</section>

			<!-- Footer -->
			<section id="footer">
				<ul class="icons">
					<li><a href="https://twitter.com/BunkyFob" class="fa-twitter"><span class="label">Twitter</span></a></li>
					<!-- <li><a href="#" class="fa-facebook"><span class="label">Facebook</span></a></li>
					<li><a href="#" class="fa-instagram"><span class="label">Instagram</span></a></li>
					<li><a href="#" class="fa-rss"><span class="label">RSS</span></a></li>
					<li><a href="#" class="fa-envelope"><span class="label">Email</span></a></li> -->
				</ul>
				<p class="copyright">&copy; Untitled. Design: <a href="http://html5up.net">HTML5 UP</a>. Images: <a href="http://unsplash.com">Unsplash</a>.</p>
			</section>

		</section>

	</div>

	<!-- Scripts -->
	<script src="/js/jquery.min.js"></script>
	<script src="/js/browser.min.js"></script>
	<script src="/js/breakpoints.min.js"></script>
	<script src="/js/util.js"></script>
	<script src="/js/main.js"></script>

</body>
</html>
