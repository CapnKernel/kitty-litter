<!DOCTYPE HTML>
<!--
	Future Imperfect by HTML5 UP
	html5up.net | @ajlkn
	Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html>
<head>
	<title>Kitty Litter - </title>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
	<link rel="stylesheet" href="/css/main.css" />
</head>
<body class="is-preload">

	<!-- Wrapper -->
	<div id="wrapper">

		<!-- Header -->
		<header id="header">
			<h1><a href="/index.html"> <img src="/images/logo.png"> Kitty Litter</a></h1>
			<nav class="links">
				<ul>
  <li><a href="/blog/index.html">Blog</a></li>
</ul>

			</nav>
			<nav class="main">
				<ul>
					<!-- <li class="search">
						<a class="fa-search" href="#search">Search</a>
						<form id="search" method="get" action="#">
							<input type="text" name="query" placeholder="Search" />
						</form>
					</li> -->
					<li class="menu">
						<a class="fa-bars" href="#menu">Menu</a>
					</li>
				</ul>
			</nav>
		</header>

		<!-- Menu -->
		<section id="menu">
			<!-- Search -->
			<!-- <section>
				<form class="search" method="get" action="#">
					<input type="text" name="query" placeholder="Search" />
				</form>
			</section> -->

			<!-- Links -->
			<section>
				<ul class="links">
			
					<li>
						<a href="/blog/index.html">
							<h3>Blog</h3>
							<p></p>
						</a>
					</li>
			
				</ul>
			</section>

			<!-- Actions -->
			<!-- <section>
				<ul class="actions stacked">
					<li><a href="#" class="button large fit">Log In</a></li>
				</ul>
			</section> -->
		</section>

		<!-- Main -->
		<div id="main">
			
			<article class="post"><p>Those who've been reading my older posts may remember I showed how you could use Enum and IntEnum as a cleaner way to declare const-type values for choices lists in Django fields.</p>

<p>That solution never felt comfortable to me, because Enum values aren't simple values.</p>

<p>So after some playing around, and a brief look over the enum.py in python 3.5, I've come up with the following:</p>

<pre><code>class ChoiceProperty:
    '''Descriptor class for yielding values, but not allowing setting.'''
    def __init__(self, value):
        self.value = value

    def __get__(self, instance, cls=None):
        return self.value


class MetaChoices(type):
    @classmethod
    def __prepare__(mcs, name, bases, **kwargs):
        '''Use an ordered dict for declared values.'''
        return OrderedDict()

    def __new__(mcs, name, bases, attrs):
        _choices = OrderedDict()
        _label_map = {}

        for name, value in list(attrs.items()):
            if not name.isupper():
                continue
            if isinstance(value, tuple):
                value, label = value
            else:
                label = name.title().replace('_', ' ')
            _choices[value] = label
            _label_map[label] = value
            attrs[name] = ChoiceProperty(value)
        attrs['_choices'] = _choices
        attrs['_labem_map'] = _label_map

        return type.__new__(mcs, name, bases, dict(attrs))

    def __getitem__(cls, key):
        return cls._choices[key]

    def __iter__(cls):
        return iter(cls._choices.items())


class Choices(metaclass=MetaChoices):
    '''Base class for choices constants.'''
</code></pre>

<h2>So, what does this all mean?</h2>

<p>First, there's the <code>ChoiceProperty</code>.  This follows the descriptor property so we can have attributes on our class that simply return a value they were told.
They do this irrespective of if it's on an instance or the class itself!</p>

<p>Last is the <code>Choices</code> class, which is empty except for declaring it has a metaclass.</p>

<p>In the middle is the meat of the work, of course.  A Metaclass defines what is done when you declare a class, or a subclass.  This lets you, as you can see here, iterate everything you're declaring on the class and do something with it <em>before</em> the class is declared.</p>

<p>So in this case it's finding all attributes of the class whose name is SHOUTY<em>SNAKE</em>CASE, and treating them as const declarations.</p>

<p>Either they're <code>NAME = Value</code>, and a label is created from the <code>NAME</code>, or they're <code>NAME = Value, Label</code>.</p>

<p>The <code>__getitem__</code> method is called when you try to subscribe the class (i.e. FOO[0]).</p>

<p>And the <code>__iter__</code> method when you try to iterate it.</p>

<h2>So what can I do with it?</h2>

<pre><code>&gt;&gt;&gt; class STATE_CHOICES(Choices):
...     NEW = 0
...     IN_PROGRESS = 1
...     REVIEW = 2, 'In Review'
...
&gt;&gt;&gt;
&gt;&gt;&gt; STATE_CHOICES.NEW
0
&gt;&gt;&gt; STATE_CHOICES.IN_PROGRESS
1
&gt;&gt;&gt; STATE_CHOICES[2]
'In Review'
&gt;&gt;&gt; list(STATE_CHOICES)
[(0, 'New'), (1, 'In Progress'), (2, 'In Review')]
</code></pre>

<p>Now, does that look useful?</p>

<pre><code>class MyModel(models.Model):
    class STATUS(Choices):
        CLOSED = 0
        NEW = 1
        PENDING = 2, 'Process Pending'
        FAILED = -1, 'Processing Failed'

    status = models.IntegerField(choices=list(STATUS), default=STATUS.NEW)
</code></pre>
</article>
			
		</div>

		<!-- Sidebar -->
		<section id="sidebar">
			<!-- Intro -->
			<section id="intro">
				<a href="/" class="logo"><img src="images/logo.jpg" alt="" /></a>
				<header>
					<h2>An alternative to Enum for Choices</h2>
					<!-- <p>An alternative to Enum for Choices</p> -->
				</header>
			</section>
			

			<!-- Mini Posts -->
			<section>
				<div class="mini-posts">

					<!-- Mini Post -->
					<!-- <article class="mini-post">
						<header>
							<h3><a href="single.html">Vitae sed condimentum</a></h3>
							<time class="published" datetime="2015-10-20">October 20, 2015</time>
							<a href="#" class="author"><img src="images/avatar.jpg" alt="" /></a>
						</header>
						<a href="single.html" class="image"><img src="images/pic04.jpg" alt="" /></a>
					</article> -->

				</div>
			</section>
			

			<!-- Posts List -->
			<!-- <section>
				<ul class="posts">
					<li>
						<article>
							<header>
								<h3><a href="single.html">Congue ullam corper lorem ipsum dolor</a></h3>
								<time class="published" datetime="2015-10-06">October 7, 2015</time>
							</header>
							<a href="single.html" class="image"><img src="images/pic12.jpg" alt="" /></a>
						</article>
					</li>
				</ul>
			</section> -->

			<!-- About -->
			<section class="blurb">
				<h2>About</h2>
				<p>Hi!</p>
				<p>I'm <strong>FunkyBob</strong>, also know as <small>Curtis Maloney</small>.</p>
				<p>Contained herein are some things I thought important enough to write about.</p>
				<!-- <ul class="actions">
					<li><a href="#" class="button">Learn More</a></li>
				</ul> -->
			</section>

			<!-- Footer -->
			<section id="footer">
				<ul class="icons">
					<li><a href="https://twitter.com/BunkyFob" class="fa-twitter"><span class="label">Twitter</span></a></li>
					<!-- <li><a href="#" class="fa-facebook"><span class="label">Facebook</span></a></li>
					<li><a href="#" class="fa-instagram"><span class="label">Instagram</span></a></li>
					<li><a href="#" class="fa-rss"><span class="label">RSS</span></a></li>
					<li><a href="#" class="fa-envelope"><span class="label">Email</span></a></li> -->
				</ul>
				<p class="copyright">&copy; Untitled. Design: <a href="http://html5up.net">HTML5 UP</a>. Images: <a href="http://unsplash.com">Unsplash</a>.</p>
			</section>

		</section>

	</div>

	<!-- Scripts -->
	<script src="/js/jquery.min.js"></script>
	<script src="/js/browser.min.js"></script>
	<script src="/js/breakpoints.min.js"></script>
	<script src="/js/util.js"></script>
	<script src="/js/main.js"></script>

</body>
</html>
